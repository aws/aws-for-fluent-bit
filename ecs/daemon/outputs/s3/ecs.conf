[FILTER]
    Name               aws
    Match              ecs.var.log.ecs.*
    imds_version       v1
    az                 false
    ec2_instance_id    true


[FILTER]
    Name                  rewrite_tag
    Match                 ecs.var.log.ecs.*
    Rule                  $ec2_instance_id ^[\S]+$  ecs.$ec2_instance_id.$TAG[4] false
    Emitter_Name          re_emitted_task
    Emitter_Storage.type  filesystem
    Emitter_Mem_Buf_Limit 10M


[OUTPUT]
    Name                         s3
    # Match all rewritten tags that have EC2 instance ID
    Match                        ecs.i*
    bucket                       ${BUCKET_ECS_DATAPLANE}
    region                       ${REGION_ECS_DATAPLANE}
    upload_timeout               ${UPLOAD_TIMEOUT_ECS_DATAPLANE}
    total_file_size              ${TOTAL_FILE_SIZE_ECS_DATAPLANE}
    s3_key_format                /aws/ecs/${CLUSTER_NAME}/ecs/$TAG[1]/$TAG[2]/%Y/%m/%d/%H/%M/%S
    s3_key_format_tag_delimiters .
    store_dir                    /tmp/fluent-bit/s3-store

[OUTPUT]
    Name                         s3
    # Match all raw tags where we failed to add instance ID and so tag will be: ecs.var.log.ecs.{type}
    Match                        ecs.var.log.ecs.*
    bucket                       ${BUCKET_ECS_DATAPLANE}
    region                       ${REGION_ECS_DATAPLANE}
    upload_timeout               ${UPLOAD_TIMEOUT_ECS_DATAPLANE}
    total_file_size              ${TOTAL_FILE_SIZE_ECS_DATAPLANE}
    s3_key_format                /aws/ecs/${CLUSTER_NAME}/ecs/instance-ID-lookup-failed/$TAG[4]/%Y/%m/%d/%H/%M/%S
    s3_key_format_tag_delimiters .
    store_dir                    /tmp/fluent-bit/s3-store