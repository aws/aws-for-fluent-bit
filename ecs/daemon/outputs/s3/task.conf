[FILTER]
    Name              ecs
    Match             app.var.lib.docker.containers.*
    ECS_Tag_Prefix    app.var.lib.docker.containers.
    ADD               container    $ECSContainerName
    ADD               ecs_task_id  $TaskID
    ADD               ecs_family   $TaskDefinitionFamily

[FILTER]
    Name               aws
    Match              app.var.lib.docker.containers.*
    imds_version       v2
    az                 false
    ec2_instance_id    true


[FILTER]
    Name                  rewrite_tag
    Match                 app.var.lib.docker.containers.*
    Rule                  $container ^[\S]+$  task.$ecs_family.$ec2_instance_id.$ecs_task_id.$container false
    Emitter_Name          re_emitted_task
    Emitter_Storage.type  filesystem
    Emitter_Mem_Buf_Limit ${MEM_BUF_LIMIT_REWRITE_TAG_TASK}


[OUTPUT]
    Name                         s3
    Match                        task.*
    bucket                       ${BUCKET_NAME_TASK}
    region                       ${BUCKET_REGION_TASK}
    upload_timeout               2m
    total_file_size              10M
    s3_key_format                /aws/ecs/${CLUSTER_NAME}/$TAG[0]/$TAG[1]/$TAG[2]/$TAG[3]/$TAG[4]/%Y_%m_%d/%H_%M_%S
    s3_key_format_tag_delimiters .
    store_dir                    /var/fluent-bit/s3-store/task

[OUTPUT]
    Name                         s3
    Match                        app.*
    bucket                       ${BUCKET_NAME_TASK}
    region                       ${BUCKET_REGION_TASK}
    upload_timeout               2m
    total_file_size              10M
    s3_key_format                /aws/ecs/${CLUSTER_NAME}/task/failed-to-retrieve-metadata-for/$TAG/%Y_%m_%d/%H_%M_%S
    store_dir                    /var/fluent-bit/s3-store/task-fallback