[FILTER]
    Name               aws
    Match              host.var.log.*
    imds_version       v1
    az                 false
    ec2_instance_id    true


[FILTER]
    Name                  rewrite_tag
    Match                 host.var.log.*
    Rule                  $ec2_instance_id ^[\S]+$  host.$ec2_instance_id.$TAG[3] false
    Emitter_Name          re_emitted_task
    Emitter_Storage.type  filesystem
    Emitter_Mem_Buf_Limit 10M


[OUTPUT]
    Name                         s3
    # Match all rewritten tags that have EC2 instance ID, ex: host.i-0b52d191c2a02063f.secure-20221120
    Match                        host.i*
    bucket                       ${BUCKET_HOST}
    region                       ${REGION_HOST}
    upload_timeout               ${UPLOAD_TIMEOUT_HOST}
    total_file_size              ${TOTAL_FILE_SIZE_HOST}
    s3_key_format                /aws/ecs/${CLUSTER_NAME}/host/$TAG[1]-$TAG[2]/$TAG[3]/%Y/%m/%d/%H/%M/%S
    s3_key_format_tag_delimiters .-
    store_dir                    /tmp/fluent-bit/s3-store

[OUTPUT]
    Name                         s3
    # Match all raw tags where we failed to add instance ID and so tag will be: host.var.log.{type}-date
    Match                        host.var.log.*
    bucket                       ${BUCKET_HOST}
    region                       ${REGION_HOST}
    upload_timeout               ${UPLOAD_TIMEOUT_HOST}
    total_file_size              ${TOTAL_FILE_SIZE_HOST}
    s3_key_format                /aws/ecs/${CLUSTER_NAME}/host/instance-ID-lookup-failed/$TAG[3]/%Y/%m/%d/%H/%M/%S
    s3_key_format_tag_delimiters .-
    store_dir                    /tmp/fluent-bit/s3-store